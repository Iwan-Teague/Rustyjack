name: CI

on:
  push:
  pull_request:

jobs:
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable

      - name: Check Command::new allowlist
        run: |
          rustc ci/forbid_command_new.rs -o /tmp/forbid_command_new
          /tmp/forbid_command_new

      - name: Check no new unwrap/expect callsites
        run: |
          rustc ci/no_new_unwrap_expect.rs -o /tmp/no_new_unwrap_expect
          /tmp/no_new_unwrap_expect

      - name: Check no blocking in async contexts
        run: |
          rustc ci/no_blocking_in_async.rs -o /tmp/no_blocking_in_async
          /tmp/no_blocking_in_async

      - name: Check no emoji in source
        run: |
          rustc ci/no_emoji_in_source.rs -o /tmp/no_emoji_in_source
          /tmp/no_emoji_in_source

      - name: cargo fmt check
        run: cargo fmt --all -- --check

      - name: cargo check workspace
        run: cargo check --workspace

      - name: cargo test workspace
        run: cargo test --workspace
        # Note: Tests for Linux-only crates (rustyjack-daemon socket tests) 
        # require Unix domain sockets and will only run on Linux/Unix platforms.
        # On Windows/macOS, the test files are gated with #![cfg(target_os = "linux")].

      - name: Guard against lab features in release builds
        run: |
          set +e
          output=$(cargo check --release -p rustyjack-daemon --features lab 2>&1)
          status=$?
          set -e
          if [ "$status" -eq 0 ]; then
            echo "ERROR: lab feature built in release; guardrail missing"
            exit 1
          fi
          echo "$output" | rg -q "not allowed in release builds" || {
            echo "ERROR: release guardrail did not trigger"
            echo "$output"
            exit 1
          }
